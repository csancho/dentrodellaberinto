version: '3.8'

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.0
    container_name: prestashop_traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    environment:
      - CF_API_EMAIL=${CF_API_EMAIL}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
      - ./traefik/acme:/acme
      - ./traefik/logs:/logs
    command:
      # API and dashboard
      - --api.dashboard=true
      - --api.insecure=false
      # Entry points
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Docker provider
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=prestashop-network
      # File provider for additional config
      - --providers.file.directory=/etc/traefik
      - --providers.file.watch=true
      # Certificate resolvers
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      # Global redirect to HTTPS
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      # Logging
      - --log.level=INFO
      - --log.filepath=/logs/traefik.log
      - --accesslog=true
      - --accesslog.filepath=/logs/access.log
      # Security headers
      - --entrypoints.websecure.http.tls.options=default@file
      # Metrics
      - --metrics.prometheus=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addServicesLabels=true
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.dashboard.rule=Host(`traefik.dentrodellaberinto.com`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
      # Security headers
      - "traefik.http.middlewares.security-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.security-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.security-headers.headers.stsseconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stspreload=true"
      - "traefik.http.middlewares.security-headers.headers.forcestsheader=true"
      - "traefik.http.middlewares.security-headers.headers.framedeny=true"
      - "traefik.http.middlewares.security-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerpolicy=strict-origin-when-cross-origin"
    networks:
      - prestashop-network
  # PrestaShop Application
  prestashop:
    build: .
    container_name: prestashop_app
    expose:
      - "80"
    volumes:
      - ./prestashop:/var/www/html/prestashop
      - ./uploads:/var/www/html/prestashop/upload
      - ./img:/var/www/html/prestashop/img
    environment:
      - DB_SERVER=mysql
      - DB_NAME=prestashop
      - DB_USER=prestashop
      - DB_PASSWD=prestashop
      - DB_PREFIX=ps_
      - ADMIN_MAIL=admin@prestashop.local
      - ADMIN_PASSWD=admin123
    depends_on:
      - traefik
      - mysql
      - redis
    labels:
      - "traefik.enable=true"
      # Main domain
      - "traefik.http.routers.prestashop.rule=Host(`dentrodellaberinto.com`) || Host(`www.dentrodellaberinto.com`)"
      - "traefik.http.routers.prestashop.tls=true"
      - "traefik.http.routers.prestashop.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prestashop.middlewares=prestashop-chain"
      - "traefik.http.services.prestashop.loadbalancer.server.port=80"
      # WWW redirect
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.(.*)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      # Security chain
      - "traefik.http.middlewares.prestashop-chain.chain.middlewares=www-redirect,security-headers,prestashop-compress,prestashop-ratelimit"
      # Compression
      - "traefik.http.middlewares.prestashop-compress.compress=true"
      # Rate limiting
      - "traefik.http.middlewares.prestashop-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.prestashop-ratelimit.ratelimit.burst=200"
      - "traefik.http.middlewares.prestashop-ratelimit.ratelimit.period=1m"
      # IP Whitelisting for admin (optional)
      # - "traefik.http.middlewares.admin-whitelist.ipwhitelist.sourcerange=YOUR.IP.ADDRESS/32"
    networks:
      - prestashop-network
    restart: unless-stopped

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: prestashop_mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: prestashop
      MYSQL_USER: prestashop
      MYSQL_PASSWORD: prestashop
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - prestashop-network
    restart: unless-stopped

  # Redis for caching
  redis:
    image: redis:7.0-alpine
    container_name: prestashop_redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - prestashop-network
    restart: unless-stopped

  # phpMyAdmin for database management
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: prestashop_phpmyadmin
    expose:
      - "80"
    environment:
      PMA_HOST: mysql
      PMA_USER: prestashop
      PMA_PASSWORD: prestashop
      MYSQL_ROOT_PASSWORD: root
    depends_on:
      - mysql
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`db.dentrodellaberinto.com`)"
      - "traefik.http.routers.phpmyadmin.tls=true"
      - "traefik.http.routers.phpmyadmin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.phpmyadmin.middlewares=phpmyadmin-auth,security-headers"
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"
      # Basic Auth for phpMyAdmin
      - "traefik.http.middlewares.phpmyadmin-auth.basicauth.users=${PHPMYADMIN_AUTH}"
    networks:
      - prestashop-network
    restart: unless-stopped

  # Mailcatcher for email testing
  mailcatcher:
    image: sj26/mailcatcher
    container_name: prestashop_mailcatcher
    ports:
      - "1090:1080"  # Web interface
      - "1026:1025"  # SMTP server
    networks:
      - prestashop-network
    restart: unless-stopped

  # Node.js for asset building (development)
  node:
    image: node:18-alpine
    container_name: prestashop_node
    working_dir: /app
    volumes:
      - ./prestashop:/app
    command: sh -c "npm install && npm run watch"
    networks:
      - prestashop-network
    profiles:
      - dev
    restart: "no"

networks:
  prestashop-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local